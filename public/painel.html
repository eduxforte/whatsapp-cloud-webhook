<!-- public/painel.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Atendimento WhatsApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { margin: 0; font-family: sans-serif; display: flex; height: 100vh; }
    .login { margin: auto; text-align: center; }
    .app { display: flex; width: 100%; height: 100%; }
    .sidebar {
      width: 300px; background: #f2f2f2; border-right: 1px solid #ccc; overflow-y: auto;
    }
    .chat {
      flex: 1; display: flex; flex-direction: column;
    }
    .messages {
      flex: 1; padding: 20px; overflow-y: auto;
    }
    .input-area {
      display: flex; padding: 10px; border-top: 1px solid #ccc;
    }
    .input-area input {
      flex: 1; padding: 10px; border: 1px solid #ccc;
    }
    .input-area button {
      padding: 10px 20px; margin-left: 10px;
    }
    .contact {
      padding: 10px; border-bottom: 1px solid #ddd; cursor: pointer;
    }
    .contact.active { background: #e6e6e6; }
    .etiqueta {
      display: inline-block; background: #d1e7dd; color: #0f5132;
      padding: 2px 6px; border-radius: 4px; font-size: 0.8em;
    }
  </style>
</head>
<body>
  <div id="login" class="login">
    <h2>Entrar no Painel</h2>
    <input type="password" id="senha" placeholder="Digite a senha" />
    <button onclick="logar()">Entrar</button>
    <p id="erro" style="color:red;"></p>
  </div>

  <div id="app" class="app" style="display:none;">
    <div class="sidebar" id="contatos"></div>
    <div class="chat">
      <div class="messages" id="mensagens">
        <p>Selecione um contato</p>
      </div>
      <div class="input-area">
        <input type="text" id="mensagemInput" placeholder="Digite sua mensagem..." />
        <button onclick="enviarMensagem()">Enviar</button>
      </div>
    </div>
  </div>

  <script>
    const SENHA = "1234"; // Altere aqui se quiser trocar a senha
    let interacoes = [];
    let clienteSelecionado = null;

    function logar() {
      const senhaDigitada = document.getElementById('senha').value;
      if (senhaDigitada === SENHA) {
        document.getElementById('login').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        carregarContatos();
      } else {
        document.getElementById('erro').innerText = 'Senha incorreta!';
      }
    }

    async function carregarContatos() {
      const res = await fetch('/interacoes');
      interacoes = await res.json();
      const contatosEl = document.getElementById('contatos');
      contatosEl.innerHTML = '';
      interacoes.forEach((c, i) => {
        const contato = document.createElement('div');
        contato.className = 'contact';
        contato.innerHTML = `
          <strong>${c.numero}</strong><br>
          Resposta: ${c.botao || 'Nenhuma'}<br>
          <span class="etiqueta">${c.etiqueta || 'Sem etiqueta'}</span>
        `;
        contato.onclick = () => selecionarCliente(i);
        contatosEl.appendChild(contato);
      });
    }

    function selecionarCliente(indice) {
      clienteSelecionado = interacoes[indice];
      document.querySelectorAll('.contact').forEach(e => e.classList.remove('active'));
      document.querySelectorAll('.contact')[indice].classList.add('active');
      const msgEl = document.getElementById('mensagens');
      msgEl.innerHTML = `
        <p><strong>${clienteSelecionado.numero}</strong></p>
        <p>Ãšltima resposta: ${clienteSelecionado.botao || 'Nenhuma'}</p>
        <p>Etiqueta atual: <strong>${clienteSelecionado.etiqueta || 'Sem etiqueta'}</strong></p>
        <p>
          <button onclick="adicionarEtiqueta('Interessado')">Interessado</button>
          <button onclick="adicionarEtiqueta('Sair da lista')">Sair da lista</button>
          <button onclick="adicionarEtiqueta('Sem resposta')">Sem resposta</button>
        </p>
      `;
    }

    async function enviarMensagem() {
      if (!clienteSelecionado) return alert('Selecione um cliente');
      const texto = document.getElementById('mensagemInput').value;
      if (!texto) return alert('Digite uma mensagem');
      await fetch('/responder', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ numero: clienteSelecionado.numero, mensagem: texto })
      });
      alert('Mensagem enviada!');
      document.getElementById('mensagemInput').value = '';
    }

    async function adicionarEtiqueta(etiqueta) {
      clienteSelecionado.etiqueta = etiqueta;
      await fetch('/etiquetar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ numero: clienteSelecionado.numero, etiqueta })
      });
      carregarContatos();
      selecionarCliente(interacoes.findIndex(c => c.numero === clienteSelecionado.numero));
    }
  </script>
</body>
</html>
